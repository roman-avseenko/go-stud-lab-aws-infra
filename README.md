# Reference infrastructure

### Table of Contents

<!-- toc -->

- [Requirements](#requirements)
- [Repo structure](#repo-structure)
- [Naming convention](#naming-convention)
- [Resources to be created](#resources-to-be-created)
- [Setup](#setup)
    + [Install CLI utilities](#1-install-cli-utilities)
    + [Configure your AWS credentials](#2-configure-your-aws-credentials)
    + [Clone this repo](#3-clone-this-repo-and-navigate-to-envsdev)
    + [Configure variables](#4-configure-variables)
    + [Deploy infrastructure](#5-deploy-infrastructure)
    + [Review outputs](#6-review-outputs)
- [Support](#support)

<!-- tocstop -->

## Requirements

 - Terraform 1.11
 - AWS CLI
 - AWS account

## Repo structure

```bash
.
├── README.md
├── envs
│ └── dev
└── modules
    └── ecs-rds-infra
```

**envs** dir contains respected envs. Please note that terraform get dir
name as a key for creating resources.

**modules** dir contains actually...modules for terraform.

## Naming convention

The AWS resources names contains project name (e.g. calculator) its type (e.g. vpc),
the name of the environment (e.g. dev) and a unique identifier (based on random string).

For example, calculator-vpc-dev-2tum67n7.

- The value of the environment depends on the name of directory inside **envs** dir
- The value of the identifier changes on "cold" run of *terraform apply*.

## Resources to be created

 - Complete VPC for ECS cluster
 - Complete VPC database
 - Peering connection between VPCs
 - Empty ECS cluster
 - RDS based PostgreSQL database
> Database will be only accessible from the VPC for ECS.

## Setup

### 1. Install CLI utilities

- [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)

- [Terraform](https://www.terraform.io/downloads)

### 2. Configure your AWS credentials
Specify AWS user`s credentials using AWS CLI:
```bash
aws configure --profile name
```
Note:
>Flag *--profile* is optional, without this flag credentials will be provided for *default* profile.
More information [here](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html).

### 3. Clone this repo and navigate to *envs/dev*

```bash
git clone git@github.com:roman-avseenko/go-stud-lab-aws-infra.git && cd go-stud-lab-aws-infra/env/dev/
```
### 4. Configure variables

 Open *main.tf*. There are variables to be configured for your application:
  - *project_name* - name of your project that will be used to tag resources
  - *db_name* - name of database that will be created
  - *db_username* - username of database user
  - *application_port* - port that will be exposed to the Internet (on which application can handle requests)

 Save the file after making changes.

### 5. Deploy infrastructure

```bash
terraform init && terraform apply --auto-approve
```
> Duration of the deployment is up to 10 minutes

### 6. Review outputs

   After the deployment is completed, you will receive a similar output:
```bash
Outputs:

db_instance_endpoint = "calculator-db-dev-20w2n7hq.clnwh1qzuuls.eu-north-1.rds.amazonaws.com:5432"
db_password = "ty355fU2zYD0uAV0"
ecs_cluster_name = "calculator-ecs-dev-20w2n7hq"
```
   This data contains  
- *db_instance_endpoint* - created database hostname and port
- *db_password* - created database password (autogenerated)
- *ecs_cluster_name* - created ECS cluster name

## Support 
   If you have any problems or (and) questions, contact me on [Telegram](https://t.me/Roman_Avseenko)

### Enjoy!